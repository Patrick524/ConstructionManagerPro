{% extends "base.html" %}

{% block title %}Clock In/Out - Construction Timesheet{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="page-title">
            <i class="fas fa-clock text-primary me-2"></i>Clock In/Out System
        </h1>
    </div>
    <div class="col-md-4">
        <div class="d-flex justify-content-md-end align-items-center h-100">
            <a href="{{ url_for('worker_history') }}" class="btn btn-outline-secondary">
                <i class="fas fa-history me-2"></i>View Timesheet History
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Current Status</h5>
            </div>
            <div class="card-body">
                {% if active_session %}
                    <div class="alert alert-success mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas fa-play-circle fa-3x text-success"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Currently Clocked In</h5>
                                <div class="text-muted">
                                    Since {{ active_session.clock_in.strftime('%I:%M %p') }}
                                </div>
                            </div>
                        </div>
                        
                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-briefcase me-2 text-primary"></i>
                                    Job
                                </div>
                                <span class="badge bg-secondary">
                                    {{ active_session.job.job_code }} - {{ active_session.job.description }}
                                </span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-hammer me-2 text-primary"></i>
                                    Activity
                                </div>
                                <span class="badge bg-secondary">
                                    {{ active_session.labor_activity.name }}
                                </span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-hourglass-half me-2 text-primary"></i>
                                    Duration
                                </div>
                                <span class="badge bg-primary" id="current-duration">
                                    Calculating...
                                </span>
                            </li>
                        </ul>

                        <form method="POST" action="{{ url_for('clock_out') }}">
                            {{ clock_out_form.hidden_tag() }}
                            
                            <div class="mb-3">
                                <label for="notes" class="form-label">Additional Notes</label>
                                {{ clock_out_form.notes(class="form-control", rows=3, placeholder="Enter any notes about your work (optional)") }}
                            </div>
                            
                            <button type="submit" class="btn btn-danger btn-lg w-100">
                                <i class="fas fa-stop-circle me-2"></i>Clock Out
                            </button>
                        </form>
                    </div>
                {% else %}
                    <div class="alert alert-warning mb-4">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-stop-circle fa-3x text-warning"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Not Clocked In</h5>
                                <div class="text-muted">
                                    Use the form on the right to clock in for a job.
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <div class="text-center">
                        <p class="text-muted mb-0">Today's Status:</p>
                        <h3>{{ today_hours }} hours logged today</h3>
                        <p class="text-muted">{{ session_count }} session(s) completed</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        {% if not active_session %}
        <div class="card h-100">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Clock In</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('clock_in') }}">
                    {{ clock_in_form.hidden_tag() }}
                    
                    <div class="mb-3">
                        <label for="job_id" class="form-label">Select Job</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-briefcase"></i></span>
                            {{ clock_in_form.job_id(class="form-select", id="job_select") }}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="labor_activity_id" class="form-label">Select Activity</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-hammer"></i></span>
                            {{ clock_in_form.labor_activity_id(class="form-select", id="activity_select") }}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        {{ clock_in_form.notes(class="form-control", rows=3, placeholder="Enter any notes about your work (optional)") }}
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        <i class="fas fa-play-circle me-2"></i>Clock In
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Recent Activity</h5>
            </div>
            <div class="card-body">
                {% if recent_sessions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Job</th>
                                    <th>Activity</th>
                                    <th>Hours</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in recent_sessions %}
                                <tr>
                                    <td>{{ session.clock_in.strftime('%m/%d/%Y') }}</td>
                                    <td>{{ session.job.job_code }}</td>
                                    <td>{{ session.labor_activity.name }}</td>
                                    <td>{{ "%.2f"|format(session.get_duration_hours()) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <h5>No recent activity</h5>
                        <p class="text-muted">Your completed sessions will appear here</p>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Today's Sessions</h5>
            </div>
            <div class="card-body">
                {% if today_sessions %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Job</th>
                                    <th>Activity</th>
                                    <th>Clock In</th>
                                    <th>Clock Out</th>
                                    <th>Duration</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in today_sessions %}
                                <tr>
                                    <td>{{ session.job.job_code }}</td>
                                    <td>{{ session.labor_activity.name }}</td>
                                    <td>{{ session.clock_in.strftime('%I:%M %p') }}</td>
                                    <td>
                                        {% if session.clock_out %}
                                            {{ session.clock_out.strftime('%I:%M %p') }}
                                        {% else %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if session.clock_out %}
                                            {{ "%.2f"|format(session.get_duration_hours()) }} hours
                                        {% else %}
                                            <span class="text-muted">In progress</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if session.notes %}
                                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="{{ session.notes }}">
                                                <i class="fas fa-sticky-note"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-secondary">
                                    <td colspan="4" class="text-end"><strong>Total Hours:</strong></td>
                                    <td colspan="2"><strong>{{ "%.2f"|format(today_hours) }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-day fa-3x text-muted mb-3"></i>
                        <h5>No sessions recorded today</h5>
                        <p class="text-muted">Use the clock in form to start tracking your time</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Dynamic labor activity dropdown based on selected job
        const jobSelect = document.getElementById('job_select');
        const activitySelect = document.getElementById('activity_select');
        
        if (jobSelect && activitySelect) {
            jobSelect.addEventListener('change', function() {
                const jobId = this.value;
                
                // Clear current options
                activitySelect.innerHTML = '';
                
                // Fetch labor activities for the selected job
                fetch(`/api/labor_activities/${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(activity => {
                            const option = document.createElement('option');
                            option.value = activity.id;
                            option.textContent = activity.name;
                            activitySelect.appendChild(option);
                        });
                    });
            });
            
            // Trigger change event to load activities for the initial job selection
            jobSelect.dispatchEvent(new Event('change'));
        }
        
        // Update duration counter for active sessions
        const durationDisplay = document.getElementById('current-duration');
        if (durationDisplay) {
            // Get the clock-in time from the data attribute
            {% if active_session %}
                const clockInTime = new Date('{{ active_session.clock_in.isoformat() }}');
                
                function updateDuration() {
                    const now = new Date();
                    const durationMs = now - clockInTime;
                    const durationHours = durationMs / (1000 * 60 * 60);
                    durationDisplay.textContent = durationHours.toFixed(2) + ' hours';
                }
                
                // Update immediately and then every minute
                updateDuration();
                setInterval(updateDuration, 60000);
            {% endif %}
        }
        
        // Initialize tooltips for notes
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}