{% extends "base.html" %}

{% block title %}Today's Billing - {{ today.strftime('%B %d, %Y') }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Today's Billing Summary</h2>
                <div class="badge bg-primary fs-6">{{ today.strftime('%A, %B %d, %Y') }}</div>
            </div>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Hours</h5>
                            <h3 class="text-primary">{{ "%.1f"|format(total_hours) }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Cost</h5>
                            <h3 class="text-success">${{ "%.2f"|format(total_cost) }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Active Jobs</h5>
                            <h3 class="text-info">{{ job_summary|length }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Time Entries</h5>
                            <h3 class="text-warning">{{ time_entries|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>

            {% if not time_entries %}
            <div class="alert alert-info">
                <h5>No Approved Time Entries</h5>
                <p>There are no approved time entries for today ({{ today.strftime('%B %d, %Y') }}). This could mean:</p>
                <ul>
                    <li>No workers have submitted time entries yet</li>
                    <li>Time entries haven't been approved by foremen</li>
                    <li>Workers are using clock-in/out system instead of manual entries</li>
                </ul>
            </div>
            {% else %}

            <!-- Job Summary Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-briefcase"></i> Job Summary</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Job</th>
                                    <th class="text-center">Workers</th>
                                    <th class="text-center">Hours</th>
                                    <th class="text-end">Cost</th>
                                    <th class="text-center">Avg Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job_name, summary in job_summary.items() %}
                                <tr>
                                    <td>
                                        <strong>{{ job_name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ summary.workers|join(', ') }}</small>
                                    </td>
                                    <td class="text-center">{{ summary.worker_count }}</td>
                                    <td class="text-center">{{ "%.1f"|format(summary.hours) }}</td>
                                    <td class="text-end">${{ "%.2f"|format(summary.cost) }}</td>
                                    <td class="text-center">
                                        {% if summary.hours > 0 %}
                                            ${{ "%.2f"|format(summary.cost / summary.hours) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-dark">
                                    <th>Total</th>
                                    <th class="text-center">{{ time_entries|map(attribute='user')|list|unique|length }}</th>
                                    <th class="text-center">{{ "%.1f"|format(total_hours) }}</th>
                                    <th class="text-end">${{ "%.2f"|format(total_cost) }}</th>
                                    <th class="text-center">
                                        {% if total_hours > 0 %}
                                            ${{ "%.2f"|format(total_cost / total_hours) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Detailed Time Entries -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Detailed Time Entries</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Worker</th>
                                    <th>Job</th>
                                    <th>Activity</th>
                                    <th class="text-center">Hours</th>
                                    <th class="text-center">Rate</th>
                                    <th class="text-end">Cost</th>
                                    <th class="text-center">Approved</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in time_entries %}
                                <tr>
                                    <td>{{ entry.user.name }}</td>
                                    <td>
                                        <strong>{{ entry.job.job_code }}</strong>
                                        <br>
                                        <small class="text-muted">{{ entry.job.description[:30] }}{% if entry.job.description|length > 30 %}...{% endif %}</small>
                                    </td>
                                    <td>{{ entry.labor_activity.name if entry.labor_activity else 'General Labor' }}</td>
                                    <td class="text-center">{{ "%.1f"|format(entry.hours) }}</td>
                                    <td class="text-center">${{ "%.2f"|format(entry.user.burden_rate or 0) }}</td>
                                    <td class="text-end">${{ "%.2f"|format(entry.hours * (entry.user.burden_rate or 0)) }}</td>
                                    <td class="text-center">
                                        {% if entry.approved %}
                                            <span class="badge bg-success">Yes</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="mt-4 d-flex gap-2">
                <a href="{{ url_for('generate_reports') }}" class="btn btn-primary">
                    <i class="fas fa-file-pdf"></i> Generate Full Report
                </a>
                {% if current_user.is_admin() %}
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-tachometer-alt"></i> Admin Dashboard
                </a>
                {% endif %}
                {% if current_user.is_foreman() %}
                <a href="{{ url_for('foreman_dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-users"></i> Foreman Dashboard
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}